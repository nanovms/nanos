version: 2
jobs:
  build:
    docker:
      # specify the version
      - image: circleci/golang:1.11
    working_directory: /go/src/github.com/nanovms/nanos
    steps:
      - checkout
      # specify any bash command here prefixed with `run: `
      - run: sudo apt-get update
      - run: sudo apt-get install nasm qemu
      - run: cd .. && git clone git@github.com:nanovms/ops.git
      - run: make
      - run: make test-nokvm
  nightly-build:
    docker:
      - image: circleci/golang:1.11
    working_directory: /go/src/github.com/nanovms/nanos
    steps:
      - checkout
      - run: sudo apt-get update
      - run: sudo apt-get install nasm
      - run: make
      - run: make test-nokvm
      - run: cp .circleci/boto ~/.boto
      - run: wget https://storage.googleapis.com/pub/gsutil.tar.gz
      - run: tar xfz gsutil.tar.gz -C ~
      - run: mkdir temp && cp output/stage3/stage3.img temp/ && cp output/boot/boot.img temp/ && cp output/mkfs/bin/mkfs temp/
      - run: cd temp && tar cvzf nanos-nightly-linux.tar.gz * && ~/gsutil/gsutil cp nanos-nightly-linux.tar.gz gs://nanos/release/nightly
      - run: ~/gsutil/gsutil acl ch -u AllUsers:R gs://nanos/release/nightly/nanos-nightly-linux.tar.gz
      - run: rm -r temp
      - run: echo $(date +"%m%d%Y") > nanos-nightly-linux.timestamp
      - run: ~/gsutil/gsutil cp nanos-nightly-linux.timestamp gs://nanos/release/nightly
      - run: ~/gsutil/gsutil acl ch -u AllUsers:R gs://nanos/release/nightly/nanos-nightly-linux.timestamp
  
  nightly-build-mac:
    macos:
        xcode: "9.0" 
    steps:
      - checkout
      - run: CI=1 /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
      - run: brew update && brew install nasm && brew install go
      - run: brew tap nanovms/homebrew-x86_64-elf
      - run: brew install x86_64-elf-binutils
      - run: make
      - run: cp .circleci/boto ~/.boto
      - run: wget https://storage.googleapis.com/pub/gsutil.tar.gz
      - run: tar xfz gsutil.tar.gz -C ~
      - run: mkdir temp && cp output/stage3/stage3.img temp/ && cp output/boot/boot.img temp/ && cp output/mkfs/bin/mkfs temp/
      - run: cd temp && tar cvzf nanos-nightly-darwin.tar.gz * && ~/gsutil/gsutil cp nanos-nightly-darwin.tar.gz gs://nanos/release/nightly
      - run: ~/gsutil/gsutil acl ch -u AllUsers:R gs://nanos/release/nightly/nanos-nightly-darwin.tar.gz
      - run: rm -r temp
      - run: echo $(date +"%m%d%Y") > nanos-nightly-darwin.timestamp
      - run: ~/gsutil/gsutil cp nanos-nightly-darwin.timestamp gs://nanos/release/nightly
      - run: ~/gsutil/gsutil acl ch -u AllUsers:R gs://nanos/release/nightly/nanos-nightly-darwin.timestamp

workflows:
  version: 2
  commit-workflow:
    jobs:
      - build
  nightly:
    triggers:
      - schedule:
          cron: "0 2 * * *" # 7PM PST
          filters:
            branches:
              only:
                - master
    jobs:
      - nightly-build
      - nightly-build-mac
